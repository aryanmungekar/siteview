<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0">
  <title>Project Media - SiteView</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>
  <link rel="stylesheet" href="assets/style.css">
  <link rel="stylesheet" href="assets/transition.css">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/exif-js/2.3.0/exif.min.js"></script>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="firebase-config.js"></script>
  <style>
    body {
      font-family: sans-serif;
      margin: 0;
      background: #f4f4f4;
    }
    #logoutBtn {
      position: fixed;
      top: 10px;
      right: 10px;
      background: crimson;
      color: white;
      padding: 8px 14px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      z-index: 999;
    }
    .media-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 16px;
      padding: 20px;
    }
    .media-card {
      background: white;
      border-radius: 12px;
      box-shadow: 0 6px 10px rgba(0,0,0,0.1);
      padding: 10px;
    }
    .media-card img,
    .media-card video {
      width: 100%;
      height: 140px;
      object-fit: cover;
      border-radius: 8px;
    }
    .media-actions {
      display: flex;
      justify-content: space-between;
      margin-top: 10px;
    }
    .media-actions button {
      background: none;
      border: none;
      font-size: 18px;
      cursor: pointer;
      color: #007bff;
    }
    .fab-upload {
      position: fixed;
      bottom: 80px;
      right: 16px;
      width: 60px;
      height: 60px;
      border-radius: 50%;
      background: #007bff;
      color: white;
      font-size: 28px;
      border: none;
      cursor: pointer;
      z-index: 1000;
    }
    .bottom-nav {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      height: 60px;
      background: white;
      display: flex;
      justify-content: space-around;
      align-items: center;
      border-top: 1px solid #ccc;
    }
    .bottom-nav a {
      font-size: 24px;
      color: #007bff;
      text-decoration: none;
    }
    .modal {
      position: fixed;
      top:0;left:0;
      width:100%;
      height:100%;
      background:rgba(0,0,0,0.5);
      display:flex;
      justify-content:center;
      align-items:center;
      z-index:10000;
    }
    .modal-content {
      background:white;
      padding:20px;
      border-radius:10px;
      width:90%;
      max-width:400px;
    }
    .modal-content input,
    .modal-content select,
    .modal-content button {
      width:100%;
      padding:10px;
      margin:8px 0;
    }
    #loadingOverlay {
      position:fixed;
      top:0;
      left:0;
      width:100%;
      height:100%;
      background:rgba(0,0,0,0.4);
      z-index:10001;
      display:none;
      justify-content:center;
      align-items:center;
      color:white;
      font-size:1.5em;
      font-weight:bold;
    }
  </style>
</head>
<body>
  <button id="logoutBtn" onclick="logout()">Logout</button>
  <h2 style="text-align:center;padding-top:16px;" id="projectTitle">Project</h2>
  <div id="loadingOverlay">Uploading...</div>
  <div id="emptyMessage" style="text-align:center;margin-top:40px;display:none;color:#555;">No media found. Tap + to add.</div>
  <div id="mediaGrid" class="media-grid"></div>
  <button class="fab-upload" onclick="openMediaModal()"><i class="fas fa-plus"></i></button>

  <!-- Media Upload Modal -->
  <div id="mediaModal" class="modal" style="display:none">
    <div class="modal-content">
      <h3 id="modalTitle">Add Media</h3>
      <input type="file" id="mediaFile" accept="image/*,video/*"/>
      <input type="text" id="mediaTitle" placeholder="Title"/>
      <select id="mediaCategory">
        <option value="images">Image</option>
        <option value="panoramic">Panoramic</option>
        <option value="video">Video</option>
      </select>
      <label><input type="checkbox" id="customDateToggle"/> Choose Date</label>
      <input type="date" id="customDateInput" style="display:none"/>
      <button onclick="submitMedia()">Save</button>
      <button onclick="closeMediaModal()">Cancel</button>
    </div>
  </div>

  <div class="bottom-nav">
    <a href="dashboard.html"><i class="fas fa-home"></i></a>
    <a href="#" onclick="openMediaModal()"><i class="fas fa-upload"></i></a>
    <a href="#"><i class="fas fa-user-circle"></i></a>
  </div>
<script src="assets/transition.js"></script>
<script>
  let currentUser, projectKey, mediaData = { images: {}, panoramic: {}, video: {} }, editingMedia = null;

  auth.onAuthStateChanged(u => {
    if (!u) return location.href = 'index.html';
    currentUser = u;
    const params = new URLSearchParams(location.search);
    projectKey = params.get('project');
    loadProject();
  });

  function loadProject() {
    db.ref('projects/' + projectKey).once('value').then(snap => {
      const project = snap.val();
      if (!project) return alert('Project not found');
      document.getElementById('projectTitle').textContent = project.projectName;
    });

    db.ref('data/' + projectKey).once('value').then(snap => {
      mediaData = snap.val() || { images: {}, panoramic: {}, video: {} };
      renderMedia();
    });
  }

  function renderMedia() {
    const grid = document.getElementById('mediaGrid');
    grid.innerHTML = '';
    let count = 0;
    ['images', 'panoramic', 'video'].forEach(cat => {
      const items = mediaData[cat] || {};
      Object.entries(items).forEach(([k, item]) => {
        count++;
        grid.appendChild(createMediaCard(item, cat, k));
      });
    });
    document.getElementById('emptyMessage').style.display = count ? 'none' : 'block';
  }

  function createMediaCard(item, cat, key) {
    const div = document.createElement('div');
    div.className = 'media-card';
    div.innerHTML = (cat === 'video'
      ? `<video src="${item.url}" controls></video>`
      : `<img src="${item.url}" />`) +
      `<h4>${item.title}</h4><p>${item.date || ''}</p>`;

    const actions = document.createElement('div');
    actions.className = 'media-actions';
    actions.innerHTML = `
      <button onclick="editMedia('${cat}','${key}')"><i class="fas fa-edit"></i></button>
      <button onclick="deleteMedia('${cat}','${key}')"><i class="fas fa-trash-alt"></i></button>
      ${item.lat && item.lon ? `<button onclick="previewMap(${item.lat}, ${item.lon}, '${item.title}')"><i class="fas fa-map-marker-alt"></i></button>` : ''}
    `;
    div.appendChild(actions);
    return div;
  }

  function openMediaModal() {
    editingMedia = null;
    document.getElementById('modalTitle').textContent = 'Add Media';
    document.getElementById('mediaFile').value = '';
    document.getElementById('mediaTitle').value = '';
    document.getElementById('mediaCategory').value = 'images';
    document.getElementById('customDateToggle').checked = false;
    document.getElementById('customDateInput').style.display = 'none';
    document.getElementById('customDateInput').value = '';
    document.getElementById('mediaModal').style.display = 'flex';
  }

  function closeMediaModal() {
    document.getElementById('mediaModal').style.display = 'none';
  }

  document.getElementById('customDateToggle').addEventListener('change', (e) => {
    document.getElementById('customDateInput').style.display = e.target.checked ? 'block' : 'none';
  });

  function editMedia(cat, key) {
    editingMedia = { cat, key };
    const item = mediaData[cat][key];
    document.getElementById('modalTitle').textContent = 'Edit Media';
    document.getElementById('mediaTitle').value = item.title;
    document.getElementById('mediaCategory').value = cat;
    document.getElementById('customDateToggle').checked = !!item.date;
    document.getElementById('customDateInput').style.display = item.date ? 'block' : 'none';
    document.getElementById('customDateInput').value = item.date || '';
    document.getElementById('mediaModal').style.display = 'flex';
  }

  function deleteMedia(cat, key) {
    if (!confirm('Delete this media?')) return;
    delete mediaData[cat][key];
    db.ref('data/' + projectKey).set(mediaData).then(renderMedia);
  }

  function showLoader(show) {
    document.getElementById('loadingOverlay').style.display = show ? 'flex' : 'none';
  }

  function submitMedia() {
    const fileField = document.getElementById('mediaFile');
    const title = document.getElementById('mediaTitle').value.trim();
    const category = document.getElementById('mediaCategory').value;
    const useCustom = document.getElementById('customDateToggle').checked;
    const customDate = document.getElementById('customDateInput').value;

    if (!title || (!fileField.files.length && !editingMedia)) return alert('Provide title and file.');

    const file = fileField.files[0];
    const key = editingMedia ? editingMedia.key : db.ref().push().key;

    showLoader(true);

    const uploadFile = editingMedia && !file ? Promise.resolve(mediaData[category][key].url)
      : uploadToCloudinary(file);

    uploadFile.then(url => {
      const item = { title, url };
      const finish = () => {
        mediaData[category] = mediaData[category] || {};
        mediaData[category][key] = item;
        db.ref('data/' + projectKey).set(mediaData).then(() => {
          showLoader(false);
          closeMediaModal();
          renderMedia();
        });
      };

      if (useCustom && customDate) {
        item.date = customDate;
        return finish();
      }

      if (file?.type.startsWith('image/')) {
        EXIF.getData(file, function () {
          const dt = EXIF.getTag(this, 'DateTimeOriginal');
          const gpsLat = EXIF.getTag(this, 'GPSLatitude');
          const gpsLon = EXIF.getTag(this, 'GPSLongitude');
          if (dt) item.date = dt.split(' ')[0].replace(/:/g, '-');
          if (gpsLat && gpsLon) {
            item.lat = gpsLat[0] + gpsLat[1] / 60 + gpsLat[2] / 3600;
            item.lon = gpsLon[0] + gpsLon[1] / 60 + gpsLon[2] / 3600;
          }
          finish();
        });
      } else {
        item.date = new Date().toISOString().split('T')[0];
        finish();
      }
    }).catch(err => {
      showLoader(false);
      alert('Upload failed: ' + err.message);
    });
  }

  function uploadToCloudinary(file) {
    const cd = cloudinaryConfig; // cloudinaryConfig must be defined in your `firebase-config.js` or another included file
    const fd = new FormData();
    fd.append('file', file);
    fd.append('upload_preset', cd.uploadPreset);
    return fetch(cd.apiUrl, { method: 'POST', body: fd })
      .then(res => res.json())
      .then(data => data.secure_url);
  }

  function previewMap(lat, lon, title) {
    const modal = document.createElement('div');
    modal.className = 'modal';
    modal.style.zIndex = 10001;
    modal.innerHTML = `
      <div class="modal-content" style="max-width:600px;">
        <h3>${title}</h3>
        <div id="leafletMap" style="height:300px;border-radius:8px;"></div>
        <button onclick="this.closest('.modal').remove()">Close</button>
      </div>`;
    document.body.appendChild(modal);
    setTimeout(() => {
      const map = L.map('leafletMap').setView([lat, lon], 16);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; OpenStreetMap contributors'
      }).addTo(map);
      L.marker([lat, lon]).addTo(map).bindPopup(title).openPopup();
    }, 50);
  }

  function logout() {
    auth.signOut().then(() => location.href = 'index.html');
  }
</script>
</body>
</html>
